<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Path to Immortality WASM</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<h1>Path to Immortality - WASM Demo</h1>
<div class="status" id="status">加载中...</div>
<button onclick="fetchChallenges()" style="margin-top: 10px; padding: 8px 16px; cursor: pointer;">
    获取挑战列表
</button>
<div class="result" id="result"></div>

<!-- 加载WASM执行环境 -->
<script src="wasm_exec.js"></script>
<script>
    // 全局变量存储WASM实例状态
    let wasmLoaded = false;

    // 初始化并加载WASM
    async function initWasm() {
        const statusEl = document.getElementById('status');
        try {
            // 1. 创建Go实例
            const go = new Go();

            // 2. 加载WASM文件（先转为ArrayBuffer确保兼容性）
            statusEl.textContent = "正在加载WASM模块...";
            const response = await fetch('main.wasm');
            if (!response.ok) {
                throw new Error(`加载失败: ${response.status} ${response.statusText}`);
            }
            const bytes = await response.arrayBuffer();

            // 3. 实例化并运行WASM
            statusEl.textContent = "正在初始化WASM模块...";
            const result = await WebAssembly.instantiate(bytes, go.importObject);
            go.run(result.instance);

            // 4. 标记加载完成
            wasmLoaded = true;
            statusEl.textContent = "WASM模块加载成功";
            statusEl.className = "status success";
            console.log("WASM模块已就绪");

        } catch (error) {
            wasmLoaded = false;
            statusEl.textContent = `加载失败: ${error.message}`;
            statusEl.className = "status error";
            console.error("WASM加载错误:", error);
        }
    }

    // 调用Go注册的listChallenge函数
    async function fetchChallenges() {
        const resultEl = document.getElementById('result');
        const statusEl = document.getElementById('status');

        if (!wasmLoaded) {
            resultEl.textContent = "WASM模块尚未加载完成，请稍后再试";
            return;
        }

        try {
            statusEl.textContent = "正在调用listChallenge...";
            resultEl.textContent = "加载中...";

            // 调用Go注册的全局函数
            const result = listChallenge();

            // 显示成功结果（格式化JSON）
            resultEl.textContent = JSON.stringify(result, null, 4);
            statusEl.textContent = "调用成功";
            statusEl.className = "status success";

        } catch (error) {
            resultEl.textContent = `调用失败: ${error.message}`;
            statusEl.textContent = "调用出错";
            statusEl.className = "status error";
            console.error("调用错误:", error);
        }
    }

    // 页面加载完成后初始化WASM
    window.onload = initWasm;
</script>
</body>
</html>
